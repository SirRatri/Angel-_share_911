"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import Image from "next/image";
import { motion, AnimatePresence } from "framer-motion";
import { Search, Home, Library, Settings, Bell, Heart, Eye, Menu, X } from "lucide-react";
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

// --- 1. UTILS & CONFIG (Gi·∫£ l·∫≠p c·∫•u tr√∫c d·ª± √°n l·ªõn) ---
function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

// Bitmask cho th·ªÉ lo·∫°i (K·ªπ thu·∫≠t t·ªëi ∆∞u CPU)
const GENRES = {
  ALL: 0,
  ROMANCE: 1 << 0,  // 0001
  ACTION: 1 << 1,   // 0010
  BOYS_LOVE: 1 << 2,// 0100
  NOVEL: 1 << 3,    // 1000
  SEX: 1 << 4       // 10000 (D·ª±a theo ·∫£nh c·ªßa b·∫°n :D)
};

// Data gi·∫£ l·∫≠p (Sau n√†y l·∫•y t·ª´ file JSON tƒ©nh tr√™n CDN)
const MOCK_DB = [
  { id: 1, title: "C√¥ D√¢u Th·ªßy Th·∫ßn", views: 5000000, likes: 87000, chapter: 128, cover: "https://images.unsplash.com/photo-1618519764620-7403abdbdfe9?w=400&q=80", mask: GENRES.ROMANCE | GENRES.NOVEL },
  { id: 2, title: "N∆∞·ªõc M·∫Øt ƒê√≥a Hoa T√†n", views: 63000000, likes: 465000, chapter: 45, cover: "https://images.unsplash.com/photo-1640536437532-6e216260a4f5?w=400&q=80", mask: GENRES.ROMANCE | GENRES.SEX },
  { id: 3, title: "Khi Chu√¥ng ƒêi·ªán Tho·∫°i Reo", views: 42000000, likes: 251000, chapter: 90, cover: "https://images.unsplash.com/photo-1614726365203-c3df95a5f979?w=400&q=80", mask: GENRES.ACTION | GENRES.ROMANCE },
  { id: 4, title: "Ti·ªÉu Th∆∞ ƒê·ªèng ƒê·∫£nh", views: 2000000000, likes: 867000, chapter: 210, cover: "https://images.unsplash.com/photo-1541963463532-d68292c34b19?w=400&q=80", mask: GENRES.NOVEL | GENRES.ROMANCE },
  { id: 5, title: "Fullhouse - Ng√¥i Nh√†", views: 30000000, likes: 255000, chapter: 15, cover: "https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=400&q=80", mask: GENRES.ROMANCE },
  { id: 6, title: "Solo Leveling", views: 99000000, likes: 1200000, chapter: 179, cover: "https://images.unsplash.com/photo-1536053428945-8c76efde5e81?w=400&q=80", mask: GENRES.ACTION },
  { id: 7, title: "Bj Alex", views: 12000000, likes: 500000, chapter: 80, cover: "https://images.unsplash.com/photo-1620336655052-b57986f5a26a?w=400&q=80", mask: GENRES.BOYS_LOVE | GENRES.SEX },
  { id: 8, title: "Painter of the Night", views: 45000000, likes: 900000, chapter: 102, cover: "https://images.unsplash.com/photo-1578632767115-351597cf2477?w=400&q=80", mask: GENRES.BOYS_LOVE },
];

const CATEGORIES = [
  { id: GENRES.ROMANCE, label: "Truy·ªán ng√¥n t√¨nh" },
  { id: GENRES.SEX, label: "Truy·ªán 18+" }, // Label ng·∫Øn g·ªçn h∆°n trong ·∫£nh
  { id: GENRES.BOYS_LOVE, label: "Boy's love" },
  { id: GENRES.NOVEL, label: "Ti·ªÉu thuy·∫øt" },
  { id: GENRES.ACTION, label: "H√†nh ƒë·ªông" },
];

// H√†m format s·ªë (30M, 255K) cho g·ªçn
const formatNumber = (num: number) => {
  return Intl.NumberFormat("en-US", {
    notation: "compact",
    maximumFractionDigits: 1
  }).format(num);
};

// --- 2. COMPONENTS ---

// Card Truy·ªán (Optimized Component)
const ComicCard = ({ data }: { data: typeof MOCK_DB[0] }) => {
  return (
    <motion.div
      layout
      initial={{ opacity: 0, scale: 0.9 }}
      animate={{ opacity: 1, scale: 1 }}
      exit={{ opacity: 0, scale: 0.9 }}
      transition={{ duration: 0.2 }}
      className="group relative flex flex-col gap-2 cursor-pointer"
    >
      {/* Container ·∫£nh: Aspect Ratio c·ªë ƒë·ªãnh ƒë·ªÉ tr√°nh nh·∫£y layout (CLS) */}
      <div className="relative w-full aspect-[3/4] rounded-2xl overflow-hidden bg-gray-200 shadow-sm border border-brand-accent/30">
        
        {/* Badge Chap M·ªõi */}
        <div className="absolute top-2 right-2 z-10 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-md">
           Ch. {data.chapter}
        </div>

        {/* ·∫¢nh Lazy Load */}
        <Image
          src={data.cover}
          alt={data.title}
          fill
          loading="lazy"
          className="object-cover transition-transform duration-500 group-hover:scale-110 will-change-transform"
          sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 20vw"
        />
        
        {/* L·ªõp ph·ªß khi hover */}
        <div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
      </div>

      {/* Th√¥ng tin */}
      <div className="space-y-1">
        <h3 className="font-bold text-gray-800 text-sm md:text-base line-clamp-2 leading-tight min-h-[2.5em] group-hover:text-pink-500 transition-colors">
          {data.title}
        </h3>
        
        {/* Stats thay v√¨ text d√†i */}
        <div className="flex items-center justify-between text-xs text-gray-500 font-medium">
          <div className="flex items-center gap-1 bg-white/50 px-1.5 py-0.5 rounded-md">
            <Eye size={12} className="text-blue-400" />
            <span>{formatNumber(data.views)}</span>
          </div>
          <div className="flex items-center gap-1 bg-white/50 px-1.5 py-0.5 rounded-md">
            <Heart size={12} className="text-red-400 fill-red-400/20" />
            <span>{formatNumber(data.likes)}</span>
          </div>
        </div>
      </div>
    </motion.div>
  );
};

// --- 3. MAIN PAGE LAYOUT ---

export default function HomePage() {
  const [activeTab, setActiveTab] = useState(0); // 0 = All
  const [searchQuery, setSearchQuery] = useState("");
  const [results, setResults] = useState(MOCK_DB);
  const [isSidebarOpen, setSidebarOpen] = useState(false);

  // LOGIC T√åM KI·∫æM & L·ªåC (Gi·∫£ l·∫≠p Web Worker logic)
  const handleFilter = useCallback(() => {
    // K·ªπ thu·∫≠t Debounce c√≥ th·ªÉ √°p d·ª•ng ·ªü ƒë√¢y n·∫øu data l·ªõn
    let filtered = MOCK_DB;

    // 1. L·ªçc theo Tag (Bitmasking - Si√™u nhanh)
    if (activeTab !== 0) {
      filtered = filtered.filter(item => (item.mask & activeTab) === activeTab);
    }

    // 2. L·ªçc theo t√™n (Search)
    if (searchQuery.trim()) {
      const q = searchQuery.toLowerCase();
      filtered = filtered.filter(item => item.title.toLowerCase().includes(q));
    }

    setResults(filtered);
  }, [activeTab, searchQuery]);

  // Trigger l·ªçc m·ªói khi input thay ƒë·ªïi
  useEffect(() => {
    handleFilter();
  }, [handleFilter]);

  return (
    <div className="flex min-h-screen bg-brand-bg font-sans overflow-x-hidden">
      
      {/* MOBILE MENU BUTTON */}
      <button 
        onClick={() => setSidebarOpen(!isSidebarOpen)}
        className="md:hidden fixed top-4 left-4 z-50 p-2 bg-brand-sidebar rounded-full shadow-lg"
      >
        {isSidebarOpen ? <X size={20} /> : <Menu size={20} />}
      </button>

      {/* --- SIDEBAR --- */}
      <aside className={cn(
        "fixed md:sticky top-0 h-screen w-64 bg-brand-sidebar border-r border-orange-100 flex flex-col p-6 z-40 transition-transform duration-300 md:translate-x-0",
        isSidebarOpen ? "translate-x-0" : "-translate-x-full"
      )}>
        {/* Logo */}
        <div className="mb-12 flex flex-col items-center">
            <div className="w-20 h-20 rounded-full bg-white border-2 border-brand-primary p-1 overflow-hidden shadow-lg mb-2">
                 {/* Gi·∫£ l·∫≠p logo th·ªè trong ·∫£nh */}
                 <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Bunny" alt="Logo" className="w-full h-full object-cover" />
            </div>
            <h1 className="font-bold text-xl text-center text-orange-800 leading-tight">
                Dream<br/><span className="text-brand-primary">weaver</span>
            </h1>
        </div>

        {/* Menu Items */}
        <nav className="flex-1 space-y-4">
            {[
                { icon: Home, label: "Home", active: true },
                { icon: Library, label: "Th∆∞ vi·ªán", active: false },
                { icon: Settings, label: "C√†i ƒë·∫∑t", active: false },
            ].map((item, idx) => (
                <button key={idx} className={cn(
                    "flex items-center gap-4 w-full p-3 rounded-xl transition-all font-medium",
                    item.active 
                        ? "bg-brand-bg text-brand-primary shadow-sm border border-orange-100" 
                        : "text-gray-600 hover:bg-white/50"
                )}>
                    <item.icon size={22} strokeWidth={item.active ? 2.5 : 2} />
                    <span>{item.label}</span>
                </button>
            ))}
        </nav>

        <div className="mt-auto text-xs text-center text-gray-400">
            v1.0.0 (Beta)
        </div>
      </aside>

      {/* --- MAIN CONTENT --- */}
      <main className="flex-1 p-4 md:p-8 w-full max-w-7xl mx-auto">
        
        {/* Header: Search & User */}
        <header className="flex flex-col-reverse md:flex-row items-center justify-between gap-4 mb-8">
            {/* Search Bar Gradient nh∆∞ thi·∫øt k·∫ø */}
            <div className="relative w-full md:w-2/3 max-w-xl group">
                <div className="absolute inset-0 bg-gradient-to-r from-pink-200 to-blue-200 rounded-full blur opacity-40 group-hover:opacity-60 transition-opacity"></div>
                <div className="relative flex items-center bg-white/80 backdrop-blur-sm rounded-full px-4 py-3 shadow-sm border border-white">
                    <Search className="text-gray-400 mr-3" size={20} />
                    <input 
                        type="text" 
                        placeholder="T√¨m ki·∫øm truy·ªán..." 
                        className="bg-transparent border-none outline-none w-full text-gray-700 placeholder-gray-400"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            {/* User Profile */}
            <div className="flex items-center gap-3 self-end md:self-auto">
                 <div className="text-right hidden sm:block">
                    <p className="text-sm font-bold text-gray-700">Trang Hu·ª≥nh</p>
                    <p className="text-xs text-green-600 font-semibold bg-green-100 px-2 rounded-full inline-block">Up Max</p>
                 </div>
                 <div className="w-10 h-10 rounded-full bg-pink-100 border border-white shadow-md overflow-hidden">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Trang" alt="User" />
                 </div>
            </div>
        </header>

        {/* Categories (Horizontal Scroll) */}
        <div className="mb-8 overflow-x-auto scrollbar-hide py-2">
            <div className="flex gap-3 min-w-max">
                <button 
                    onClick={() => setActiveTab(0)}
                    className={cn(
                        "px-6 py-3 rounded-full font-medium transition-all shadow-sm whitespace-nowrap",
                        activeTab === 0 
                            ? "bg-brand-primary text-white shadow-brand-primary/30" 
                            : "bg-white text-gray-500 hover:bg-gray-50"
                    )}
                >
                    T·∫•t c·∫£
                </button>
                {CATEGORIES.map(cat => (
                    <button 
                        key={cat.id}
                        onClick={() => setActiveTab(cat.id)}
                        className={cn(
                            "px-6 py-3 rounded-full font-medium transition-all shadow-sm whitespace-nowrap",
                            activeTab === cat.id
                                ? "bg-brand-primary text-white shadow-brand-primary/30" 
                                : "bg-brand-accent/20 text-gray-700 hover:bg-brand-accent/40"
                        )}
                    >
                        {cat.label}
                    </button>
                ))}
            </div>
        </div>

        {/* Content Grid */}
        <section>
            <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-800">Truy·ªán hot c·ªßa tu·∫ßn</h2>
                <span className="text-sm text-brand-primary font-medium cursor-pointer hover:underline">Xem th√™m</span>
            </div>

            {results.length === 0 ? (
                <div className="text-center py-20 text-gray-400">
                    <p>Kh√¥ng t√¨m th·∫•y truy·ªán n√†o ü•≤</p>
                </div>
            ) : (
                <motion.div 
                    layout
                    className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6"
                >
                    <AnimatePresence>
                        {results.map((comic) => (
                            <ComicCard key={comic.id} data={comic} />
                        ))}
                    </AnimatePresence>
                </motion.div>
            )}
        </section>

      </main>
    </div>
  );
}
